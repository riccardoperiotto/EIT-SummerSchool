<!DOCTYPE html>
<html>

<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<title>Parschnell</title>

	<!-- library import -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
		integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
		integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
		integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
		integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
		crossorigin="anonymous"></script>

	<!-- personal file import -->
	<link rel="stylesheet" href="/css/list.css">
	<link rel="stylesheet" href="/css/progress_bar.css">

	<script src="statemachineGUI.js"></script>

<body onload="initialize()">
	<div class="px-3">
		<div class="row mx-auto justify-content-between">
			<div class="col-12 text-center col-md-6 text-md-left" style="height: 100px;">
				<img src="img/logo.png" class="img-fluid p-2 ml-2 h-100" alt="Parschnell logo">
				<img src="img/eit.png" class="img-fluid p-2 ml-2 h-100" alt="EIT Digital logo">
			</div>
			<div class="col-12 text-left col-md-6 text-md-center">
				<div class="row d-flex h-100">
					<div class="col m-auto">
						<div class="input-group">
							<input type="input" id="typeCode" class="form-control rounded"
								placeholder="Insert the typecode to process.." aria-label="Typecode"
								aria-describedby="search-addon" value="- D 2 A200 B200 W1/EACAN-G24" />
							<button type="button" id="start_button" class="btn btn-primary mx-4"
								onclick="onStartClick()">Start</button>
						</div>
					</div>
				</div>
			</div>
		</div>	
		<div id="message" class="row" style="height: 50%;">
			<div class="col text-center">
				<div class="mx-auto ">
					<img src="img/logo.png" class="img-fluid p-2 h-100" alt="Parschnell logo">
					<h5 class="m-5 font-italic">Insert a valid type code in the searchbar</h5>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-3" style="height: 500px; overflow-y: auto;">
				<div id="assembly_data_list">
					<!-- GENERATED BY THE CODE AUTOMATICALLY -->
					<!-- <div class="list-group list-group-root well">
						<p class="list-group-item"><b>Group</b></a>
						<div class="list-group">
							<p class="list-group-item">Action</p>
							<p class="list-group-item">Action</p>
							<p class="list-group-item">Action</p> -->
					<!-- THE FOLLOWING IS NOT SHOWN IF THE ASSEMBLY STEPS ARE NOT CONSIDERED	 -->
					<!-- <div class="list-group">`;
								<a href="#" class="list-group-item">Step</a>
							</div> -->
					<!-- </div>
					</div>
					<div class="list-group list-group-root well">
						<p class="list-group-item"><b>Group</b></a>
						<div class="list-group">
							<p class="list-group-item">Action</a>
							<p class="list-group-item">Action</a>
							<p class="list-group-item">Action</a> -->

					<!-- THE FOLLOWING IS NOT SHOWN IF THE ASSEMBLY STEPS ARE NOT CONSIDERED	 -->
					<!-- <div class="list-group">`;
								<a href="#" class="list-group-item">Step</a>
							</div> -->
					<!-- </div>
					</div> -->
				</div>
			</div>
			<div class="col-9">
				<div id="current_action p-4">
					<div class="text-center p-3">
						<h2 id="action_path" style="display: none;">Group/Action</h2>
						<h2 id="end_message" style="display: none;">Process finished</h2>
					</div>
					<div class="text-center p-3">
						<div class="row mx-2">
							<div class="col text-center py-5">
								<ul id="action_bar" class="progressbar">
									<!-- GENERATED BY THE CODE AUTOMATICALLY -->
									<!-- <li class="active" style="width: 25%;">Step 1</li>
									<li style="width: 25%;">Step 2</li>
									<li style="width: 25%;">Step 3</li>
									<li style="width: 25%;">Step 4</li> -->
								</ul>
							</div>
						</div>
					</div>
					<div class="text-center p-3">
						<div class="row">
							<div class="col">
								<button type="button" id="next_button" class="btn btn-primary mx-auto px-4"
									onclick="onNextClick()" style="display: none;">Next</button>
								<button type="button" id="new_button" class="btn btn-danger mt-4 mx-auto px-4"
									onclick="onNewClick()" style="display: none;">New</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


</body>
<script>
	let assemblyData = [];
	let typeCode = "";
	let semanticCheck = true; // TODO: implementation
	let endOfProcess = false;

	// indexes to track currenlty elaborating group and action
	let groupIndex = 0;
	let actionIndex = 0;
	let stepIndex = 0;

	let proxy = new Proxy({}, {
		set: function (target, key, value) {
			endOfProcess = false;
			assemblyData = value;
			showAssemblyData();
			return true;
		}
	});

	function onStartClick() {
		typeCode = document.getElementById("typeCode").value;
		if (!typeCode || typeCode.trim() == "") {
			alert("Enter a code!")
			return;
		}
		runCommand("send Parse.ParseSignal(" + typeCode + ") to production");
		RequestRuntimeValue("production.assemblyData");
		RequestRuntimeValue("production.typeCodeCheck");
	}



	function showAssemblyData() {
		let innerHtml = `<div class="list-group list-group-root well">`;

		// left column
		assemblyData.forEach((group, i) => {
			innerHtml += `<p id="group${i}" class="list-group-item ${!i ? 'current' : ''}"><b>${group.groupName}</b></p>`;
			innerHtml += `<div class="list-group">`;
			group.actionList.forEach((action, j) => {
				innerHtml += `<p id="action${j}_group${i}" class="list-group-item ${!i && !j ? 'current' : ''}">${action.actionName}</p>`;
				// innerHtml += `<div class="list-group">`;
				// WE DECIDED TO REMOVE THE ASSEMBLY STEPS FROM THE LIST
				// action.assemblySteps.forEach(step => {
				// 	innerHtml += `<a href="#" class="list-group-item">${step}</a>`;
				// })
				// innerHtml += `</div>`;
			});
			innerHtml += `</div>`;
		});
		innerHtml += `</div>`;

		document.getElementById("assembly_data_list").innerHTML = innerHtml;

		// main content in the center
		showAction();

		// next button
		document.getElementById("next_button").style.display = "block";
	}

	function showAction() {
		if (!semanticCheck) {
			// it means: the code was sintactically right but not semantically and 
			// the state machine got stucked in one atate
			window.location.reload();
		} else if (assemblyData && assemblyData.length && !endOfProcess) {
			document.getElementById("message").style.display = "none";
			document.getElementById("start_button").disabled = "disabled";
			document.getElementById("start_button").classList.remove("btn-primary");
			document.getElementById("start_button").classList.add("btn-secondary");
			document.getElementById("action_path").innerText = `${assemblyData[groupIndex].groupName}/${assemblyData[groupIndex].actionList[actionIndex].actionName}`;
			document.getElementById("action_path").style.display = "block";

			// circle for the progress bar
			let innerHTML = "";
			let widthPercentage = Math.round(100 / assemblyData[groupIndex].actionList[actionIndex].assemblySteps.length) + '%';
			assemblyData[groupIndex].actionList[actionIndex].assemblySteps.forEach((step, k) => {
				innerHTML += `<li id="step${k}" ${!k ? ' class="current"' : ''} style="width: ${widthPercentage};">${step}</li>`;
			}
			);
			document.getElementById("action_bar").innerHTML = innerHTML;
		} else {
			// going to see
		}
	}

	function onNextClick() {
		nextStep();
	}

	function nextStep() {
		document.getElementById(`step${stepIndex}`).classList.remove("current");
		document.getElementById(`step${stepIndex}`).classList.add("active");


		if (++stepIndex == assemblyData[groupIndex].actionList[actionIndex].assemblySteps.length) {
			stepIndex = 0;
			nextAction();
		}
		else {
			document.getElementById(`step${stepIndex}`).classList.add("current");
		}
	}

	function nextAction() {
		document.getElementById(`action${actionIndex}_group${groupIndex}`).classList.remove("current");
		document.getElementById(`action${actionIndex}_group${groupIndex}`).classList.add("active");

		if (++actionIndex == assemblyData[groupIndex].actionList.length) {
			actionIndex = 0;
			nextGroup();
		}
		else {
			document.getElementById(`action${actionIndex}_group${groupIndex}`).classList.add("current");
		}
		showAction();
	}

	function nextGroup() {
		document.getElementById(`group${groupIndex}`).classList.remove("current");
		document.getElementById(`group${groupIndex}`).classList.add("active");

		if (++groupIndex == assemblyData.length) {
			groupIndex = 0;
			showEnd();
		}
		else {
			document.getElementById(`group${groupIndex}`).classList.add("current");
			document.getElementById(`action${actionIndex}_group${groupIndex}`).classList.add("current");
		}
	}

	function showEnd() {
		endOfProcess = true;

		document.getElementById("action_path").style.display = "none";
		document.getElementById("end_message").style.display = "block";
		document.getElementById("action_bar").innerHTML = "";

		document.getElementById("next_button").style.display = "none";
		document.getElementById("new_button").style.display = "block";
	}

	function onNewClick() {
		proxy.assemblyData = [];
		document.getElementById("typeCode").value = "- D 2 A200 B200 W1/EACAN-G24";

		broadcast("New");

		document.getElementById("action_path").style.display = "none";
		document.getElementById("end_message").style.display = "none";
		document.getElementById("message").style.display = "block";
		document.getElementById("start_button").disabled = "";
		document.getElementById("start_button").classList.remove("btn-secondary");
		document.getElementById("start_button").classList.add("btn-primary");

		document.getElementById("next_button").style.display = "none";
		document.getElementById("new_button").style.display = "none";
	}
</script>

</html>